# 云存档功能 - 前端使用示例

## 配置信息

### 服务器配置
- **服务器IP**: 114.55.115.211
- **存储目录**: `D:\PlayLinker\Storage\Saves`
- **API Base URL**: `https://114.55.115.211/api/v1`
- **最大文件大小**: 100MB

### 目录结构
```
D:\PlayLinker\Storage\Saves\
├── user_1001\
│   ├── game_10001\
│   │   ├── cloud_20241127_100000_abc123.dat
│   │   └── cloud_20241127_100001_def456.dat
│   └── game_10002\
│       └── cloud_20241127_100002_ghi789.dat
└── user_1002\
    └── game_10001\
        └── cloud_20241127_100003_jkl012.dat
```

---

## 前端实现示例

### 1. 上传存档到云端

#### HTML
```html
<template>
  <div class="cloud-upload">
    <h3>上传存档到云端</h3>
    
    <!-- 文件选择 -->
    <input 
      type="file" 
      ref="fileInput"
      @change="handleFileSelect"
      accept=".dat,.sav,.save"
    />
    
    <!-- 选项 -->
    <div class="options">
      <label>
        <input type="checkbox" v-model="compress" />
        压缩文件（节省空间）
      </label>
    </div>
    
    <!-- 上传按钮 -->
    <button 
      @click="uploadToCloud" 
      :disabled="!selectedFile || uploading"
    >
      {{ uploading ? '上传中...' : '上传到云端' }}
    </button>
    
    <!-- 进度条 -->
    <div v-if="uploading" class="progress">
      <div class="progress-bar" :style="{ width: uploadProgress + '%' }">
        {{ uploadProgress }}%
      </div>
    </div>
  </div>
</template>
```

#### JavaScript (Vue 3)
```javascript
<script setup>
import { ref } from 'vue'
import axios from 'axios'

const API_BASE = 'https://114.55.115.211/api/v1'
const saveId = ref(1) // 从列表中获取
const selectedFile = ref(null)
const compress = ref(true)
const uploading = ref(false)
const uploadProgress = ref(0)

// 文件选择
function handleFileSelect(event) {
  const file = event.target.files[0]
  if (file) {
    if (file.size > 100 * 1024 * 1024) {
      alert('文件大小不能超过100MB')
      return
    }
    selectedFile.value = file
    console.log('选择的文件:', file.name, '大小:', (file.size / 1024 / 1024).toFixed(2), 'MB')
  }
}

// 上传到云端
async function uploadToCloud() {
  if (!selectedFile.value) {
    alert('请先选择文件')
    return
  }
  
  uploading.value = true
  uploadProgress.value = 0
  
  try {
    const formData = new FormData()
    formData.append('file', selectedFile.value)
    formData.append('saveId', saveId.value)
    formData.append('compress', compress.value)
    formData.append('encrypt', false)
    formData.append('description', '手动上传')
    
    const response = await axios.post(`${API_BASE}/cloud/upload`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      onUploadProgress: (progressEvent) => {
        uploadProgress.value = Math.round((progressEvent.loaded * 100) / progressEvent.total)
      }
    })
    
    console.log('上传成功:', response.data)
    alert('存档已上传到云端！')
    
    // 清空选择
    selectedFile.value = null
    fileInput.value.value = ''
    
  } catch (error) {
    console.error('上传失败:', error)
    alert('上传失败: ' + (error.response?.data?.message || error.message))
  } finally {
    uploading.value = false
    uploadProgress.value = 0
  }
}
</script>
```

---

### 2. 从云端下载存档

#### HTML
```html
<template>
  <div class="cloud-saves-list">
    <h3>我的云存档</h3>
    
    <div v-for="save in cloudSaves" :key="save.cloudBackupId" class="save-item">
      <div class="save-info">
        <h4>{{ save.gameName }}</h4>
        <p>上传时间: {{ formatDate(save.uploadTime) }}</p>
        <p>文件大小: {{ save.fileSizeMB }} MB</p>
      </div>
      
      <button @click="downloadFromCloud(save.cloudBackupId)">
        下载
      </button>
    </div>
  </div>
</template>
```

#### JavaScript (Vue 3)
```javascript
<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'

const API_BASE = 'https://114.55.115.211/api/v1'
const cloudSaves = ref([])

// 获取云存档列表
async function fetchCloudSaves() {
  try {
    const response = await axios.get(`${API_BASE}/cloud/saves`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    cloudSaves.value = response.data.data.items
    console.log('云存档列表:', cloudSaves.value)
    
  } catch (error) {
    console.error('获取云存档列表失败:', error)
  }
}

// 从云端下载
async function downloadFromCloud(cloudBackupId) {
  try {
    const response = await axios.get(
      `${API_BASE}/cloud/download/${cloudBackupId}`,
      {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        responseType: 'blob' // 重要：告诉axios这是文件下载
      }
    )
    
    // 创建下载链接
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', `${cloudBackupId}.dat`)
    document.body.appendChild(link)
    link.click()
    
    // 清理
    link.remove()
    window.URL.revokeObjectURL(url)
    
    console.log('下载成功')
    
  } catch (error) {
    console.error('下载失败:', error)
    alert('下载失败: ' + (error.response?.data?.message || error.message))
  }
}

// 格式化日期
function formatDate(dateString) {
  return new Date(dateString).toLocaleString('zh-CN')
}

onMounted(() => {
  fetchCloudSaves()
})
</script>
```

---

### 3. 完整示例（带样式）

```vue
<template>
  <div class="cloud-storage-page">
    <h2>云存档管理</h2>
    
    <!-- 上传区域 -->
    <div class="upload-section">
      <h3>上传存档</h3>
      <div class="upload-box">
        <input 
          type="file" 
          ref="fileInput"
          @change="handleFileSelect"
          style="display: none"
        />
        <button @click="$refs.fileInput.click()" class="select-file-btn">
          选择文件
        </button>
        <span v-if="selectedFile">{{ selectedFile.name }}</span>
        
        <label class="compress-option">
          <input type="checkbox" v-model="compress" />
          压缩文件
        </label>
        
        <button 
          @click="uploadToCloud" 
          :disabled="!selectedFile || uploading"
          class="upload-btn"
        >
          {{ uploading ? `上传中 ${uploadProgress}%` : '上传' }}
        </button>
      </div>
    </div>
    
    <!-- 云存档列表 -->
    <div class="saves-section">
      <h3>我的云存档</h3>
      <div class="saves-grid">
        <div v-for="save in cloudSaves" :key="save.cloudBackupId" class="save-card">
          <h4>{{ save.gameName }}</h4>
          <p>{{ formatDate(save.uploadTime) }}</p>
          <p>{{ save.fileSizeMB }} MB</p>
          <button @click="downloadFromCloud(save.cloudBackupId)">
            下载
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'

const API_BASE = 'https://114.55.115.211/api/v1'
const selectedFile = ref(null)
const compress = ref(true)
const uploading = ref(false)
const uploadProgress = ref(0)
const cloudSaves = ref([])

function handleFileSelect(event) {
  selectedFile.value = event.target.files[0]
}

async function uploadToCloud() {
  if (!selectedFile.value) return
  
  uploading.value = true
  const formData = new FormData()
  formData.append('file', selectedFile.value)
  formData.append('saveId', 1)
  formData.append('compress', compress.value)
  
  try {
    await axios.post(`${API_BASE}/cloud/upload`, formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      onUploadProgress: (e) => {
        uploadProgress.value = Math.round((e.loaded * 100) / e.total)
      }
    })
    alert('上传成功！')
    fetchCloudSaves()
  } catch (error) {
    alert('上传失败')
  } finally {
    uploading.value = false
    selectedFile.value = null
  }
}

async function fetchCloudSaves() {
  const res = await axios.get(`${API_BASE}/cloud/saves`)
  cloudSaves.value = res.data.data.items
}

async function downloadFromCloud(id) {
  const res = await axios.get(`${API_BASE}/cloud/download/${id}`, {
    responseType: 'blob'
  })
  const url = URL.createObjectURL(new Blob([res.data]))
  const link = document.createElement('a')
  link.href = url
  link.download = `${id}.dat`
  link.click()
  URL.revokeObjectURL(url)
}

function formatDate(date) {
  return new Date(date).toLocaleString('zh-CN')
}

onMounted(fetchCloudSaves)
</script>

<style scoped>
.cloud-storage-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.upload-section, .saves-section {
  margin-bottom: 40px;
}

.upload-box {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 20px;
  border: 2px dashed #ccc;
  border-radius: 8px;
}

.saves-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
}

.save-card {
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
}

button {
  padding: 10px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
</style>
```

---

## 测试步骤

### 1. 在服务器上创建存储目录
在Windows服务器上执行：
```powershell
New-Item -Path "D:\PlayLinker\Storage\Saves" -ItemType Directory -Force
```

### 2. 测试上传
```bash
curl -X POST https://114.55.115.211/api/v1/cloud/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test_save.dat" \
  -F "saveId=1" \
  -F "compress=true"
```

### 3. 测试下载
```bash
curl -X GET https://114.55.115.211/api/v1/cloud/download/cloud_xxx \
  -H "Authorization: Bearer YOUR_TOKEN" \
  --output downloaded_save.dat
```

---

## 注意事项

1. **文件大小限制**: 最大100MB，可在 `appsettings.json` 中修改
2. **存储空间**: 需要定期监控服务器磁盘空间
3. **备份**: 建议定期备份 `D:\PlayLinker\Storage\Saves` 目录
4. **权限**: 确保ASP.NET Core进程有权限读写该目录
5. **HTTPS**: 生产环境建议配置SSL证书
6. **压缩**: 开启压缩可节省约50%空间，但会增加CPU使用
