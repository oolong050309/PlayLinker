# PlayLinker 云存档功能 - 服务器部署说明

## 服务器信息

- **服务器IP**: 114.55.115.211
- **操作系统**: Windows Server
- **地域**: 华东1（杭州）
- **实例ID**: i-bp10te6m2votipk138ux

---

## 部署步骤

### 1. 创建存储目录

在服务器上打开 PowerShell（管理员权限），执行：

```powershell
# 创建存档存储目录
New-Item -Path "D:\PlayLinker\Storage\Saves" -ItemType Directory -Force

# 验证目录创建成功
Test-Path "D:\PlayLinker\Storage\Saves"
# 应该返回 True
```

### 2. 设置目录权限

确保 IIS 应用程序池用户有权限读写该目录：

```powershell
# 给 IIS_IUSRS 组添加完全控制权限
$path = "D:\PlayLinker\Storage\Saves"
$acl = Get-Acl $path
$permission = "IIS_IUSRS","FullControl","ContainerInherit,ObjectInherit","None","Allow"
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($accessRule)
Set-Acl $path $acl

# 验证权限
Get-Acl $path | Format-List
```

### 3. 配置已完成

你的 `appsettings.json` 已经配置好了：

```json
{
  "CloudStorage": {
    "StorageType": "Local",
    "LocalPath": "D:\\PlayLinker\\Storage\\Saves",
    "BaseUrl": "https://114.55.115.211/storage/saves",
    "MaxFileSizeMB": 100
  }
}
```

### 4. 重启应用

在 IIS 管理器中重启应用程序池，或执行：

```powershell
# 重启 IIS
iisreset
```

---

## 测试验证

### 1. 测试目录创建

```powershell
# 手动创建一个测试文件
New-Item -Path "D:\PlayLinker\Storage\Saves\test.txt" -ItemType File -Value "Test"

# 验证文件存在
Test-Path "D:\PlayLinker\Storage\Saves\test.txt"

# 删除测试文件
Remove-Item "D:\PlayLinker\Storage\Saves\test.txt"
```

### 2. 测试API上传

使用 Postman 或 curl 测试：

```bash
# 上传测试（需要先创建一个测试文件）
curl -X POST https://114.55.115.211/api/v1/cloud/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@test_save.dat" \
  -F "saveId=1" \
  -F "compress=false"
```

### 3. 检查文件是否保存

```powershell
# 查看存储目录内容
Get-ChildItem -Path "D:\PlayLinker\Storage\Saves" -Recurse
```

---

## 目录结构示例

上传成功后，目录结构应该如下：

```
D:\PlayLinker\Storage\Saves\
├── user_1001\
│   ├── game_10001\
│   │   ├── cloud_20241211_160000_abc123def456.dat
│   │   └── cloud_20241211_160100_xyz789ghi012.dat
│   └── game_10002\
│       └── cloud_20241211_160200_jkl345mno678.dat
└── user_1002\
    └── game_10001\
        └── cloud_20241211_160300_pqr901stu234.dat
```

---

## 监控和维护

### 1. 监控磁盘空间

```powershell
# 查看 D 盘剩余空间
Get-PSDrive D | Select-Object Used,Free

# 查看存档目录大小
$path = "D:\PlayLinker\Storage\Saves"
$size = (Get-ChildItem $path -Recurse | Measure-Object -Property Length -Sum).Sum
Write-Host "存档总大小: $([math]::Round($size/1GB, 2)) GB"
```

### 2. 定期清理（可选）

创建一个清理脚本 `cleanup_old_saves.ps1`：

```powershell
# 删除超过90天的存档
$path = "D:\PlayLinker\Storage\Saves"
$days = 90
$cutoffDate = (Get-Date).AddDays(-$days)

Get-ChildItem -Path $path -Recurse -File | 
    Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
    ForEach-Object {
        Write-Host "删除旧文件: $($_.FullName)"
        Remove-Item $_.FullName -Force
    }

# 删除空目录
Get-ChildItem -Path $path -Recurse -Directory | 
    Where-Object { (Get-ChildItem $_.FullName).Count -eq 0 } | 
    Remove-Item -Force
```

### 3. 备份存档（推荐）

创建备份脚本 `backup_saves.ps1`：

```powershell
# 备份到另一个位置
$source = "D:\PlayLinker\Storage\Saves"
$destination = "E:\Backups\PlayLinker\Saves_$(Get-Date -Format 'yyyyMMdd')"

# 创建备份
Copy-Item -Path $source -Destination $destination -Recurse -Force

Write-Host "备份完成: $destination"
```

设置定时任务每天自动备份：

```powershell
# 创建定时任务（每天凌晨2点执行）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File D:\Scripts\backup_saves.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At 2am
Register-ScheduledTask -TaskName "PlayLinker存档备份" -Action $action -Trigger $trigger
```

---

## 常见问题

### 1. 上传失败：权限不足

**错误**: `Access to the path 'D:\PlayLinker\Storage\Saves\...' is denied.`

**解决**:
```powershell
# 给 IIS 用户添加权限
icacls "D:\PlayLinker\Storage\Saves" /grant "IIS_IUSRS:(OI)(CI)F" /T
```

### 2. 上传失败：文件太大

**错误**: `ERR_FILE_TOO_LARGE`

**解决**: 修改 `appsettings.json` 中的 `MaxFileSizeMB`，或在 `web.config` 中增加限制：

```xml
<configuration>
  <system.webServer>
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="104857600" /> <!-- 100MB -->
      </requestFiltering>
    </security>
  </system.webServer>
</configuration>
```

### 3. 下载失败：文件不存在

**错误**: `ERR_FILE_NOT_FOUND`

**检查**:
```powershell
# 检查数据库中的 storage_url 是否正确
# 检查文件是否真的存在
Test-Path "D:\PlayLinker\Storage\Saves\user_xxx\game_xxx\cloud_xxx.dat"
```

### 4. 磁盘空间不足

**监控**:
```powershell
# 设置磁盘空间警报
$freeSpace = (Get-PSDrive D).Free / 1GB
if ($freeSpace -lt 10) {
    Write-Warning "磁盘空间不足！剩余: $([math]::Round($freeSpace, 2)) GB"
    # 发送邮件通知或其他操作
}
```

---

## 安全建议

### 1. 限制文件类型

在 Controller 中添加文件类型验证：

```csharp
var allowedExtensions = new[] { ".dat", ".sav", ".save" };
var extension = Path.GetExtension(file.FileName).ToLower();
if (!allowedExtensions.Contains(extension))
{
    return BadRequest("不支持的文件类型");
}
```

### 2. 防止路径遍历攻击

代码中已经使用了 `Path.Combine` 和 GUID，可以防止路径遍历。

### 3. 定期扫描病毒

```powershell
# 使用 Windows Defender 扫描
Start-MpScan -ScanPath "D:\PlayLinker\Storage\Saves" -ScanType QuickScan
```

---

## 性能优化

### 1. 启用 GZIP 压缩

在 `Program.cs` 中添加：

```csharp
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
});
```

### 2. 使用异步 I/O

代码中已经使用了 `async/await`，确保高并发性能。

### 3. 添加缓存

对于频繁下载的文件，可以考虑添加 CDN 或缓存层。

---

## 完成清单

- [x] 创建存储目录 `D:\PlayLinker\Storage\Saves`
- [x] 设置目录权限
- [x] 配置 `appsettings.json`
- [x] 实现上传接口
- [x] 实现下载接口
- [ ] 测试上传功能
- [ ] 测试下载功能
- [ ] 设置定时备份
- [ ] 配置监控告警

---

## 下一步

1. **测试功能**: 使用前端或 Postman 测试上传下载
2. **监控磁盘**: 设置磁盘空间监控
3. **配置备份**: 设置定时备份任务
4. **配置 HTTPS**: 申请SSL证书（推荐使用域名）
5. **性能测试**: 测试并发上传下载性能
